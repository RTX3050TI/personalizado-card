<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cartas de Amor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librer√≠a para comprimir la URL y hacerla m√°s corta -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Lora:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Estilos Base */
        body {
            font-family: 'Lora', serif;
            overflow-x: hidden;
            background-color: #fff0f3;
        }
        .font-handwriting {
            font-family: 'Dancing Script', cursive;
        }
        .font-ui {
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Animaci√≥n de P√©talos de fondo */
        .petal {
            position: fixed;
            top: -10%;
            z-index: 9999;
            user-select: none;
            pointer-events: none;
            animation-name: fall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(110vh) rotate(360deg) translateX(20px);
                opacity: 0;
            }
        }

        /* Cursor de M√°quina de Escribir */
        .cursor::after {
            content: '|';
            animation: blink 1s step-start infinite;
            color: #ff4d6d;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Animaci√≥n del Sobre */
        .envelope-container {
            perspective: 1000px;
            cursor: pointer;
            animation: floatEnvelope 3s ease-in-out infinite;
        }
        @keyframes floatEnvelope {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .envelope {
            position: relative;
            width: 300px;
            height: 200px;
            background: #ff4d6d;
            margin: 0 auto;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 15px 35px rgba(255, 77, 109, 0.4);
            transition: transform 0.5s;
        }
        .envelope:hover {
            transform: scale(1.05);
        }
        .flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: #ff758c;
            clip-path: polygon(0 0, 50% 100%, 100% 0);
            transform-origin: top;
            transition: transform 0.6s 0.2s, z-index 0.2s;
            z-index: 2;
        }
        .envelope.open .flap {
            transform: rotateX(180deg);
            z-index: 0;
        }
        .letter-preview {
            position: absolute;
            bottom: 0;
            left: 10px;
            width: 280px;
            height: 100px;
            background: white;
            transition: transform 0.5s 0.6s;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #ff4d6d;
        }
        .envelope.open .letter-preview {
            transform: translateY(-120px) scale(1.1);
        }
        
        /* Fotos Polaroid Animadas */
        .polaroid {
            background: white;
            padding: 10px 10px 35px 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            transform: rotate(var(--rotation));
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            animation: floatPhoto 6s ease-in-out infinite;
            animation-delay: var(--delay);
            max-width: 100%;
        }
        @keyframes floatPhoto {
            0%, 100% { transform: rotate(var(--rotation)) translateY(0); }
            50% { transform: rotate(var(--rotation)) translateY(-10px); }
        }
        .polaroid:hover {
            transform: scale(1.15) rotate(0deg) !important;
            z-index: 50;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation-play-state: paused;
        }

        /* Corazones saliendo de la foto */
        .mini-heart {
            position: absolute;
            color: #ff4d6d;
            font-size: 20px;
            opacity: 0;
            pointer-events: none;
        }
        .polaroid:hover .mini-heart {
            animation: popHeart 1s ease-out forwards;
        }
        @keyframes popHeart {
            0% { transform: translate(0, 0) scale(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(var(--mx), var(--my)) scale(1.5); opacity: 0; }
        }

        /* Utilidades ocultas */
        .hidden-section {
            display: none !important;
        }
        
        /* Fondo animado suave */
        .bg-animated {
            background: linear-gradient(-45deg, #fff0f3, #ffe5ec, #fff0f3, #ffffff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="bg-animated min-h-screen text-gray-800">

    <!-- =======================
         VISTA 1: EL FORMULARIO
         ======================= -->
    <div id="form-view" class="container mx-auto px-4 py-10 max-w-2xl hidden-section">
        <div class="bg-white/80 backdrop-blur-md rounded-3xl shadow-2xl p-8 border border-white ring-4 ring-pink-100">
            <h1 class="text-5xl font-handwriting text-center text-pink-600 mb-2 drop-shadow-sm">Creador de Cartas</h1>
            <p class="text-center text-gray-500 font-ui text-sm mb-8">‚ú® Crea un momento m√°gico y seguro ‚ú®</p>

            <form id="cardForm" class="space-y-6">
                <!-- Datos B√°sicos -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">De (Tu nombre)</label>
                        <input type="text" id="inputDe" required class="w-full bg-pink-50/50 border-pink-200 rounded-xl p-3 border focus:ring-2 focus:ring-pink-400 outline-none transition" placeholder="Ej: Luis">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Para (Su nombre)</label>
                        <input type="text" id="inputPara" required class="w-full bg-pink-50/50 border-pink-200 rounded-xl p-3 border focus:ring-2 focus:ring-pink-400 outline-none transition" placeholder="Ej: Ana">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">T√≠tulo de la Carta</label>
                    <input type="text" id="inputTitulo" required class="w-full bg-pink-50/50 border-pink-200 rounded-xl p-3 border focus:ring-2 focus:ring-pink-400 outline-none transition" placeholder="Ej: Feliz San Valent√≠n, mi amor">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Mensaje Especial</label>
                    <textarea id="inputMensaje" rows="5" required class="w-full bg-pink-50/50 border-pink-200 rounded-xl p-3 border focus:ring-2 focus:ring-pink-400 outline-none transition" placeholder="Escribe aqu√≠ lo que sientes..."></textarea>
                    <p class="text-xs text-gray-400 mt-1 text-right">Se escribir√° autom√°ticamente letra por letra.</p>
                </div>

                <!-- Fotos -->
                <div class="bg-gradient-to-br from-pink-50 to-white p-6 rounded-2xl border border-pink-100 shadow-inner">
                    <label class="block text-sm font-bold text-pink-600 mb-3 flex items-center gap-2">
                        <span>üì∏ Tus Fotos (URLs)</span>
                        <span class="text-xs font-normal text-pink-400 bg-pink-100 px-2 py-0.5 rounded-full">Se animar√°n solas</span>
                    </label>

                    <!-- Aviso sobre Facebook/Instagram -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded-r text-xs text-yellow-800 shadow-sm">
                        <p class="font-bold flex items-center gap-1">‚ö†Ô∏è ¬øTus fotos no salen?</p>
                        <p class="mt-1">Los enlaces de <strong>Facebook, Instagram o WhatsApp</strong> caducan r√°pido y dejan de verse.</p>
                        <p class="mt-2">üí° <strong>Soluci√≥n:</strong> Sube tus fotos a <a href="https://postimages.org/" target="_blank" class="underline text-blue-600 font-bold hover:text-blue-800">PostImages.org</a> (es gratis) y copia el "Enlace directo" para pegarlo aqu√≠.</p>
                    </div>

                    <div class="space-y-3">
                        <input type="url" class="photo-input w-full p-3 text-sm border border-pink-100 rounded-lg focus:ring-2 focus:ring-pink-300 outline-none transition" placeholder="URL Foto 1 (opcional)">
                        <input type="url" class="photo-input w-full p-3 text-sm border border-pink-100 rounded-lg focus:ring-2 focus:ring-pink-300 outline-none transition" placeholder="URL Foto 2 (opcional)">
                        <input type="url" class="photo-input w-full p-3 text-sm border border-pink-100 rounded-lg focus:ring-2 focus:ring-pink-300 outline-none transition" placeholder="URL Foto 3 (opcional)">
                        <input type="url" class="photo-input w-full p-3 text-sm border border-pink-100 rounded-lg focus:ring-2 focus:ring-pink-300 outline-none transition" placeholder="URL Foto 4 (opcional)">
                        <input type="url" class="photo-input w-full p-3 text-sm border border-pink-100 rounded-lg focus:ring-2 focus:ring-pink-300 outline-none transition" placeholder="URL Foto 5 (opcional)">
                    </div>
                </div>

                <!-- YouTube -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">üéµ Canci√≥n de YouTube (Link)</label>
                    <input type="url" id="inputYoutube" class="w-full bg-pink-50/50 border-pink-200 rounded-xl p-3 border focus:ring-2 focus:ring-pink-400 outline-none transition" placeholder="https://www.youtube.com/watch?v=...">
                </div>

                <!-- Botones -->
                <div class="pt-4">
                    <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-2xl hover:scale-[1.02] transform transition-all duration-300 text-xl flex items-center justify-center gap-2">
                        <span>üíå</span> Generar Carta
                    </button>
                    <p class="text-center text-xs text-gray-400 mt-3">
                        <span class="inline-block bg-green-100 text-green-700 px-2 py-1 rounded">üõ°Ô∏è Tecnolog√≠a de Compresi√≥n Activa</span> 
                    </p>
                </div>
            </form>
            
            <!-- √Årea de resultado -->
            <div id="resultArea" class="hidden mt-8 text-center bg-green-50 p-6 rounded-2xl border border-green-200 animation-fade-in">
                <p class="font-bold text-green-700 mb-2 text-lg">¬°Tu carta est√° lista!</p>
                
                <p class="text-xs text-gray-500 mb-2 px-4">
                    El enlace es un poco largo porque guarda toda tu carta de forma segura sin base de datos.
                </p>

                <div class="relative group">
                    <input type="text" id="shareLink" readonly class="w-full bg-white p-4 pr-12 rounded-xl border border-green-200 mb-4 text-xs text-gray-400 font-mono shadow-inner cursor-pointer" onclick="this.select()">
                    <span class="absolute right-4 top-4 text-gray-400">üîó</span>
                </div>

                <div class="flex flex-col gap-3 justify-center">
                    <div class="flex gap-3">
                        <button onclick="copyLink()" class="flex-1 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-4 py-3 rounded-xl font-ui font-bold transition shadow-sm hover:shadow">Copiar Enlace</button>
                        <button onclick="openLink()" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl font-ui font-bold transition shadow-md hover:shadow-lg">Ver Carta</button>
                    </div>
                    
                    <!-- BOT√ìN M√ÅGICO PARA ACORTAR -->
                    <button onclick="shortenLink()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white px-4 py-3 rounded-xl font-ui font-bold transition shadow-md hover:shadow-lg flex items-center justify-center gap-2 transform hover:scale-[1.02]">
                        <span>ü™Ñ</span> Acortar enlace (Hacerlo peque√±ito)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- =======================
         VISTA 2: EL SOBRE (Intro)
         ======================= -->
    <div id="envelope-view" class="h-screen w-full flex flex-col items-center justify-center hidden-section overflow-hidden relative">
        <!-- Decoraci√≥n de fondo simple -->
        <div class="absolute top-0 left-0 w-full h-full opacity-30 pointer-events-none">
             <div class="absolute top-10 left-10 text-4xl animate-bounce">üíï</div>
             <div class="absolute bottom-20 right-20 text-4xl animate-bounce" style="animation-delay: 1s">üíñ</div>
        </div>

        <h2 class="text-4xl md:text-5xl font-handwriting text-pink-600 mb-16 animate-pulse drop-shadow-sm z-10 text-center px-4">Alguien pens√≥ en ti...</h2>
        
        <div class="envelope-container z-10" onclick="openLetter()">
            <div class="envelope" id="mainEnvelope">
                <div class="flap"></div>
                <div class="letter-preview">
                    <span class="animate-pulse text-red-500">‚ù§Ô∏è</span>
                </div>
            </div>
        </div>
        
        <p class="mt-16 text-pink-400 font-ui text-sm uppercase tracking-widest animate-pulse">Toca el sobre para descubrir</p>
    </div>

    <!-- =======================
         VISTA 3: LA CARTA (Contenido)
         ======================= -->
    <div id="card-view" class="min-h-screen pb-20 hidden-section relative overflow-hidden flex flex-col items-center">
        <!-- M√∫sica (Invisible) -->
        <div id="music-container"></div>

        <!-- Bot√≥n flotante m√∫sica -->
        <div class="fixed top-4 right-4 z-50 bg-white/80 backdrop-blur rounded-full p-3 shadow-lg cursor-pointer hover:scale-110 transition animate-spin-slow" onclick="toggleMusicHints()">
            <span class="text-2xl">üéµ</span>
        </div>

        <!-- Contenido Principal - Layout Flex para Rodear -->
        <div class="container mx-auto px-4 pt-10 relative z-10 w-full max-w-7xl">
            
            <div class="flex flex-col md:flex-row items-center justify-between gap-8 md:gap-4 relative min-h-[700px]">
                
                <!-- Columna Izquierda / Arriba (2 Fotos) -->
                <div id="galleryLeft" class="flex flex-row md:flex-col gap-6 w-full md:w-1/4 justify-center items-center order-1 flex-wrap md:flex-nowrap">
                    <!-- Se inyectan fotos aqu√≠ -->
                </div>

                <!-- Centro (Carta) -->
                <div class="w-full md:w-2/4 order-2 z-20 flex flex-col items-center">
                    
                    <!-- Cabecera dentro del centro -->
                    <div class="text-center mb-6 transform hover:scale-105 transition duration-700">
                        <div class="inline-block bg-white/90 px-8 py-2 rounded-full shadow-lg mb-4 ring-2 ring-pink-100">
                            <span class="text-gray-400 font-ui text-xs uppercase tracking-[0.2em]">Para</span>
                            <span id="displayPara" class="text-pink-600 font-bold text-xl ml-2 font-handwriting"></span>
                        </div>
                        <h1 id="displayTitulo" class="text-4xl md:text-6xl font-handwriting text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-red-500 drop-shadow-sm mb-2 leading-tight py-2"></h1>
                        <p class="text-gray-400 font-ui text-sm">Con amor de: <span id="displayDe" class="font-bold text-gray-600"></span></p>
                    </div>

                    <!-- Tarjeta de Texto -->
                    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-2xl p-8 md:p-12 w-full border border-white relative group hover:shadow-pink-200/50 transition duration-500">
                        <!-- Decoraci√≥n esquinas -->
                        <div class="absolute -top-4 -left-4 text-5xl transform -rotate-12 drop-shadow-md transition group-hover:rotate-0">üìå</div>
                        <div class="absolute -bottom-4 -right-4 text-5xl transform rotate-12 drop-shadow-md transition group-hover:rotate-0">üíå</div>
                        
                        <div class="font-lora text-lg md:text-xl leading-loose text-gray-700 min-h-[150px] text-justify">
                            <span id="typewriterText"></span><span class="cursor"></span>
                        </div>

                        <div class="mt-8 text-center opacity-50">
                            <span class="text-3xl animate-pulse">‚ù¶</span>
                        </div>
                    </div>

                </div>

                <!-- Columna Derecha / Abajo (3 Fotos) -->
                <div id="galleryRight" class="flex flex-row md:flex-col gap-6 w-full md:w-1/4 justify-center items-center order-3 flex-wrap md:flex-nowrap">
                    <!-- Se inyectan fotos aqu√≠ -->
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-12 opacity-60 hover:opacity-100 transition pb-8">
                <a href="valentine_card.html" class="text-xs text-pink-400 hover:text-pink-600 border-b border-pink-300 pb-1 font-ui">üíù Crear mi propia carta sorpresa</a>
            </div>
        </div>
    </div>

    <!-- L√≥gica JavaScript -->
    <script>
        // --- 1. LECTURA DE URL Y ESTADO INICIAL ---
        const params = new URLSearchParams(window.location.search);
        
        // Detectar si hay datos en el formato nuevo (seguro) o antiguo
        const hasSecureData = params.has('d'); // 'd' es el par√°metro encriptado
        const hasLegacyData = params.has('para'); // Retrocompatibilidad
        
        const hasData = hasSecureData || hasLegacyData;

        // Elementos DOM principales
        const formView = document.getElementById('form-view');
        const envelopeView = document.getElementById('envelope-view');
        const cardView = document.getElementById('card-view');

        // Datos Globales
        let musicId = '';
        let messageText = '';
        let photoUrls = [];

        // Inicializaci√≥n
        if (hasData) {
            // MODO CARTA: Mostrar Sobre primero
            formView.classList.add('hidden-section');
            envelopeView.classList.remove('hidden-section');
            prepareCardData();
        } else {
            // MODO CREADOR: Mostrar Formulario
            formView.classList.remove('hidden-section');
        }

        // --- 2. FUNCIONES DEL MODO CREADOR (CON COMPRESI√ìN LZ-STRING) ---
        document.getElementById('cardForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const rawData = {
                p: document.getElementById('inputPara').value,
                d: document.getElementById('inputDe').value,
                t: document.getElementById('inputTitulo').value,
                m: document.getElementById('inputMensaje').value,
                y: '',
                f: []
            };
            
            let ytUrl = document.getElementById('inputYoutube').value;
            if (ytUrl) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = ytUrl.match(regExp);
                if (match && match[2].length === 11) {
                    rawData.y = match[2];
                }
            }
            
            document.querySelectorAll('.photo-input').forEach((input) => {
                if(input.value.trim() !== "") {
                    rawData.f.push(input.value.trim());
                }
            });

            // COMPRESI√ìN DE DATOS (NUEVO)
            const jsonString = JSON.stringify(rawData);
            // Usamos LZString para comprimir en lugar de solo Base64
            const compressedData = LZString.compressToEncodedURIComponent(jsonString);

            // Construir URL Base
            const baseUrl = window.location.href.split('?')[0];
            const finalUrl = `${baseUrl}?d=${compressedData}`;

            // Mostrar resultado
            const resultArea = document.getElementById('resultArea');
            const shareInput = document.getElementById('shareLink');
            
            resultArea.classList.remove('hidden');
            shareInput.value = finalUrl;
            
            resultArea.scrollIntoView({ behavior: 'smooth' });
        });

        function copyLink() {
            const copyText = document.getElementById("shareLink");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("¬°Enlace copiado! Si es muy largo, usa el bot√≥n 'Acortar enlace'.");
        }

        function openLink() {
            window.location.href = document.getElementById("shareLink").value;
        }

        function shortenLink() {
            const longUrl = document.getElementById("shareLink").value;
            // Abre TinyURL en una nueva pesta√±a con el enlace pre-cargado
            window.open('https://tinyurl.com/create.php?url=' + encodeURIComponent(longUrl), '_blank');
        }

        // --- 3. FUNCIONES DEL MODO CARTA (DESCOMPRESI√ìN) ---

        function prepareCardData() {
            let de, para, titulo, mensaje, yt, fotosRaw = [];

            if (hasSecureData) {
                try {
                    const encoded = params.get('d');
                    
                    // INTENTO 1: Descompresi√≥n LZString (Nuevo M√©todo)
                    let jsonString = LZString.decompressFromEncodedURIComponent(encoded);
                    
                    // INTENTO 2: Si falla o es nulo, probar m√©todo antiguo (Base64 est√°ndar)
                    if (!jsonString) {
                         try {
                            const decodedUri = atob(encoded);
                            jsonString = decodeURIComponent(decodedUri);
                         } catch(err) {
                             console.error("Error fallback decode", err);
                         }
                    }

                    if(jsonString) {
                        const data = JSON.parse(jsonString);
                        de = data.d;
                        para = data.p;
                        titulo = data.t;
                        mensaje = data.m;
                        yt = data.y;
                        fotosRaw = data.f || [];
                    } else {
                        throw new Error("Datos corruptos");
                    }

                } catch (e) {
                    alert("Error al leer la carta. El enlace podr√≠a estar incompleto o da√±ado.");
                    return;
                }
            } else {
                // FALLBACK MODO ANTIGUO
                de = params.get('de');
                para = params.get('para');
                titulo = params.get('titulo');
                mensaje = params.get('mensaje');
                yt = params.get('yt');
                for(let i=0; i<5; i++) {
                    if(params.has(`foto${i}`)) fotosRaw.push(params.get(`foto${i}`));
                }
            }

            // Setear textos
            document.getElementById('displayPara').textContent = para;
            document.getElementById('displayDe').textContent = de;
            document.getElementById('displayTitulo').textContent = titulo;
            messageText = mensaje; 

            // M√∫sica
            if (yt) musicId = yt;

            // L√≥gica Fotos (Regla de 5)
            if (fotosRaw.length === 0) {
                // 5 corazones default
                for(let i=0; i<5; i++) {
                    photoUrls.push('https://images.unsplash.com/photo-1518199266791-5375a83190b7?q=80&w=400&auto=format&fit=crop'); 
                }
            } else {
                photoUrls = [...fotosRaw];
                // Rellenar hasta 5 repitiendo
                let index = 0;
                while(photoUrls.length < 5) {
                    photoUrls.push(fotosRaw[index % fotosRaw.length]);
                    index++;
                }
            }

            // --- RENDERIZADO DE FOTOS ---
            const galleryLeft = document.getElementById('galleryLeft');
            const galleryRight = document.getElementById('galleryRight');
            
            galleryLeft.innerHTML = '';
            galleryRight.innerHTML = '';

            photoUrls.forEach((url, index) => {
                const rotation = (Math.random() * 12) - 6;
                const delay = Math.random() * 2 + 's';
                
                let heartsHTML = '';
                for(let h=0; h<3; h++) {
                    const mx = (Math.random() * 60 - 30) + 'px';
                    const my = -(Math.random() * 100 + 50) + 'px';
                    heartsHTML += `<div class="mini-heart" style="left:${50 + (Math.random()*40-20)}%; top:0; --mx:${mx}; --my:${my}; animation-delay:${h*0.2}s">‚ù§Ô∏è</div>`;
                }

                const errorImage = 'https://placehold.co/400x400/pink/white?text=Foto+Privada';

                const polaroidHTML = `
                    <div class="polaroid" style="--rotation:${rotation}deg; --delay:${delay};">
                        ${heartsHTML}
                        <div class="w-40 h-40 md:w-48 md:h-48 overflow-hidden bg-gray-100 mb-2 rounded-sm shadow-inner relative group-hover:brightness-110 transition">
                            <img src="${url}" class="w-full h-full object-cover transition transform duration-700 hover:scale-110" alt="Recuerdo" onerror="this.src='${errorImage}'">
                        </div>
                    </div>
                `;

                if (index < 2) {
                    galleryLeft.innerHTML += polaroidHTML;
                } else {
                    galleryRight.innerHTML += polaroidHTML;
                }
            });
        }

        function openLetter() {
            const envelope = document.getElementById('mainEnvelope');
            envelope.classList.add('open');
            
            document.querySelector('.envelope-container').style.animation = 'none';

            if (musicId) {
                const player = document.createElement('iframe');
                player.width = "0";
                player.height = "0";
                player.src = `https://www.youtube.com/embed/${musicId}?autoplay=1&loop=1&playlist=${musicId}&controls=0`;
                player.allow = "autoplay";
                player.style.display = "none";
                document.getElementById('music-container').appendChild(player);
            }

            setTimeout(() => {
                envelopeView.style.opacity = '0';
                envelopeView.style.transition = 'opacity 1s';
                
                setTimeout(() => {
                    envelopeView.classList.add('hidden-section');
                    cardView.classList.remove('hidden-section');
                    
                    startPetals();
                    startTypewriter();
                }, 1000);
            }, 800);
        }

        // --- 4. EFECTOS VISUALES ---

        function startTypewriter() {
            const element = document.getElementById('typewriterText');
            let i = 0;
            const speed = 50; 

            function type() {
                if (i < messageText.length) {
                    if(messageText.charAt(i) === '\n') {
                         element.innerHTML += '<br>';
                    } else {
                         element.innerHTML += messageText.charAt(i);
                    }
                    i++;
                    setTimeout(type, speed);
                } else {
                    document.querySelector('.cursor').style.display = 'none';
                }
            }
            type();
        }

        function startPetals() {
            setInterval(() => {
                const petal = document.createElement('div');
                petal.classList.add('petal');
                petal.innerHTML = Math.random() > 0.5 ? 'üå∏' : 'üíñ'; // Variedad en p√©talos
                petal.style.left = Math.random() * 100 + 'vw';
                petal.style.fontSize = (Math.random() * 20 + 15) + 'px';
                petal.style.animationDuration = (Math.random() * 3 + 3) + 's';
                
                document.body.appendChild(petal);
                setTimeout(() => { petal.remove(); }, 6000);
            }, 400);
        }

        function toggleMusicHints() {
            alert("üéµ La m√∫sica est√° sonando. Si no la escuchas, interact√∫a con la p√°gina o verifica el volumen.");
        }

    </script>
</body>
</html>
