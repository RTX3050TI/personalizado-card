<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cartas de Amor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Lora:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Estilos Base y Animaciones */
        body {
            font-family: 'Lora', serif;
            overflow-x: hidden;
        }
        .font-handwriting {
            font-family: 'Dancing Script', cursive;
        }
        .font-ui {
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Animaci√≥n de P√©talos */
        .petal {
            position: fixed;
            top: -10%;
            z-index: 9999;
            user-select: none;
            pointer-events: none;
            animation-name: fall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(110vh) rotate(360deg) translateX(20px);
                opacity: 0;
            }
        }

        /* Cursor de M√°quina de Escribir */
        .cursor::after {
            content: '|';
            animation: blink 1s step-start infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Animaci√≥n del Sobre */
        .envelope-container {
            perspective: 1000px;
            cursor: pointer;
        }
        .envelope {
            position: relative;
            width: 300px;
            height: 200px;
            background: #ff4d6d;
            margin: 0 auto;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 0.5s;
        }
        .envelope:hover {
            transform: translateY(-5px);
        }
        .flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: #ff758c;
            clip-path: polygon(0 0, 50% 100%, 100% 0);
            transform-origin: top;
            transition: transform 0.6s 0.2s, z-index 0.2s;
            z-index: 2;
        }
        .envelope.open .flap {
            transform: rotateX(180deg);
            z-index: 0;
        }
        .letter-preview {
            position: absolute;
            bottom: 0;
            left: 10px;
            width: 280px;
            height: 100px;
            background: white;
            transition: transform 0.5s 0.6s;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        .envelope.open .letter-preview {
            transform: translateY(-120px);
        }
        
        /* Fotos Polaroid */
        .polaroid {
            background: white;
            padding: 10px 10px 30px 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transform: rotate(var(--rotation));
            transition: transform 0.3s, z-index 0.3s;
        }
        .polaroid:hover {
            transform: scale(1.1) rotate(0deg);
            z-index: 50;
        }

        /* Utilidades ocultas */
        .hidden-section {
            display: none !important;
        }
    </style>
</head>
<body class="bg-pink-50 min-h-screen text-gray-800">

    <!-- =======================
         VISTA 1: EL FORMULARIO
         ======================= -->
    <div id="form-view" class="container mx-auto px-4 py-10 max-w-2xl hidden-section">
        <div class="bg-white rounded-2xl shadow-xl p-8 border-t-8 border-pink-500">
            <h1 class="text-4xl font-handwriting text-center text-pink-600 mb-2">Creador de Cartas</h1>
            <p class="text-center text-gray-500 font-ui text-sm mb-8">Dise√±a un regalo √∫nico y comparte el enlace.</p>

            <form id="cardForm" class="space-y-6">
                <!-- Datos B√°sicos -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">De (Tu nombre)</label>
                        <input type="text" id="inputDe" required class="w-full border-gray-300 rounded-lg p-3 border focus:ring-2 focus:ring-pink-400 outline-none" placeholder="Ej: Luis">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Para (Su nombre)</label>
                        <input type="text" id="inputPara" required class="w-full border-gray-300 rounded-lg p-3 border focus:ring-2 focus:ring-pink-400 outline-none" placeholder="Ej: Ana">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">T√≠tulo de la Carta</label>
                    <input type="text" id="inputTitulo" required class="w-full border-gray-300 rounded-lg p-3 border focus:ring-2 focus:ring-pink-400 outline-none" placeholder="Ej: Feliz San Valent√≠n, mi amor">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Mensaje Especial</label>
                    <textarea id="inputMensaje" rows="5" required class="w-full border-gray-300 rounded-lg p-3 border focus:ring-2 focus:ring-pink-400 outline-none" placeholder="Escribe aqu√≠ lo que sientes..."></textarea>
                    <p class="text-xs text-gray-400 mt-1 text-right">Se escribir√° autom√°ticamente letra por letra.</p>
                </div>

                <!-- Fotos -->
                <div class="bg-pink-50 p-4 rounded-lg border border-pink-100">
                    <label class="block text-sm font-bold text-pink-700 mb-3">üì∏ Tus Fotos (URLs)</label>
                    <div class="space-y-2">
                        <input type="url" class="photo-input w-full p-2 text-sm border rounded" placeholder="URL Foto 1 (opcional)">
                        <input type="url" class="photo-input w-full p-2 text-sm border rounded" placeholder="URL Foto 2 (opcional)">
                        <input type="url" class="photo-input w-full p-2 text-sm border rounded" placeholder="URL Foto 3 (opcional)">
                        <input type="url" class="photo-input w-full p-2 text-sm border rounded" placeholder="URL Foto 4 (opcional)">
                        <input type="url" class="photo-input w-full p-2 text-sm border rounded" placeholder="URL Foto 5 (opcional)">
                    </div>
                    <p class="text-xs text-pink-500 mt-2">* Si pones menos de 5, las repetiremos para que se vea bonito.</p>
                </div>

                <!-- YouTube -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">üéµ Canci√≥n de YouTube (Link)</label>
                    <input type="url" id="inputYoutube" class="w-full border-gray-300 rounded-lg p-3 border focus:ring-2 focus:ring-pink-400 outline-none" placeholder="https://www.youtube.com/watch?v=...">
                </div>

                <!-- Botones -->
                <div class="pt-4">
                    <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-red-500 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transform transition hover:-translate-y-1 text-lg">
                        üíå Generar Carta √önica
                    </button>
                </div>
            </form>
            
            <!-- √Årea de resultado -->
            <div id="resultArea" class="hidden mt-8 text-center bg-gray-50 p-6 rounded-xl border-2 border-dashed border-gray-300">
                <p class="font-bold text-green-600 mb-2">¬°Tu carta est√° lista!</p>
                <input type="text" id="shareLink" readonly class="w-full bg-white p-2 rounded border mb-4 text-sm text-gray-500">
                <div class="flex gap-2 justify-center">
                    <button onclick="copyLink()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded font-ui text-sm font-bold transition">Copiar Link</button>
                    <button onclick="openLink()" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded font-ui text-sm font-bold transition">Ver Ahora</button>
                </div>
            </div>
        </div>
    </div>

    <!-- =======================
         VISTA 2: EL SOBRE (Intro)
         ======================= -->
    <div id="envelope-view" class="h-screen w-full flex flex-col items-center justify-center bg-pink-100 hidden-section">
        <h2 class="text-3xl font-handwriting text-pink-600 mb-10 animate-bounce">Tienes una carta...</h2>
        
        <div class="envelope-container" onclick="openLetter()">
            <div class="envelope" id="mainEnvelope">
                <div class="flap"></div>
                <div class="letter-preview">‚ù§Ô∏è</div>
            </div>
        </div>
        
        <p class="mt-12 text-gray-500 font-ui text-sm">Toca el sobre para abrir</p>
    </div>

    <!-- =======================
         VISTA 3: LA CARTA (Contenido)
         ======================= -->
    <div id="card-view" class="min-h-screen pb-20 hidden-section relative overflow-hidden bg-gradient-to-b from-red-50 to-pink-100">
        <!-- M√∫sica (Invisible) -->
        <div id="music-container"></div>

        <!-- Bot√≥n flotante m√∫sica -->
        <div class="fixed top-4 right-4 z-50 bg-white/80 backdrop-blur rounded-full p-2 shadow-lg cursor-pointer animate-pulse" onclick="toggleMusicHints()">
            <span class="text-2xl">üéµ</span>
        </div>

        <!-- Contenido Principal -->
        <div class="container mx-auto px-4 pt-10 max-w-4xl relative z-10">
            
            <!-- Cabecera -->
            <div class="text-center mb-12">
                <div class="inline-block bg-white px-8 py-3 rounded-full shadow-sm mb-4">
                    <span class="text-gray-500 font-ui text-sm uppercase tracking-widest">Para: <span id="displayPara" class="text-pink-600 font-bold"></span></span>
                </div>
                <h1 id="displayTitulo" class="text-5xl md:text-6xl font-handwriting text-red-500 drop-shadow-sm mb-4 leading-tight"></h1>
                <p class="text-gray-400 font-ui text-sm">De: <span id="displayDe"></span></p>
            </div>

            <!-- Galer√≠a Polaroid (Grid Masonry Simple) -->
            <div id="photoGallery" class="flex flex-wrap justify-center gap-8 mb-16">
                <!-- Las fotos se inyectan aqu√≠ v√≠a JS -->
            </div>

            <!-- Carta Texto -->
            <div class="bg-white/90 backdrop-blur-sm rounded-lg shadow-xl p-8 md:p-12 max-w-2xl mx-auto border-t-4 border-red-400 relative">
                <!-- Decoraci√≥n esquinas -->
                <div class="absolute -top-3 -left-3 text-4xl transform -rotate-12">üìå</div>
                
                <div class="font-lora text-lg md:text-xl leading-relaxed text-gray-700 min-h-[100px]">
                    <span id="typewriterText"></span><span class="cursor"></span>
                </div>

                <div class="mt-8 text-right">
                    <div class="text-4xl text-red-400">‚ù§</div>
                </div>
            </div>

            <!-- Bot√≥n crear propia -->
            <div class="text-center mt-20 opacity-60 hover:opacity-100 transition">
                <a href="valentine_card.html" class="text-xs text-gray-500 border-b border-gray-400 pb-1">Crear mi propia carta</a>
            </div>
        </div>
    </div>

    <!-- L√≥gica JavaScript -->
    <script>
        // --- 1. LECTURA DE URL Y ESTADO INICIAL ---
        const params = new URLSearchParams(window.location.search);
        const hasData = params.has('para'); // Si tiene "para", asumimos que es una carta

        // Elementos DOM principales
        const formView = document.getElementById('form-view');
        const envelopeView = document.getElementById('envelope-view');
        const cardView = document.getElementById('card-view');

        // Datos Globales
        let musicId = '';
        let messageText = '';
        let photoUrls = [];

        // Inicializaci√≥n
        if (hasData) {
            // MODO CARTA: Mostrar Sobre primero
            formView.classList.add('hidden-section');
            envelopeView.classList.remove('hidden-section');
            prepareCardData();
        } else {
            // MODO CREADOR: Mostrar Formulario
            formView.classList.remove('hidden-section');
        }

        // --- 2. FUNCIONES DEL MODO CREADOR ---
        document.getElementById('cardForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Recolectar datos
            const de = encodeURIComponent(document.getElementById('inputDe').value);
            const para = encodeURIComponent(document.getElementById('inputPara').value);
            const titulo = encodeURIComponent(document.getElementById('inputTitulo').value);
            const mensaje = encodeURIComponent(document.getElementById('inputMensaje').value);
            
            // Recolectar YouTube ID
            let ytUrl = document.getElementById('inputYoutube').value;
            let ytId = '';
            if (ytUrl) {
                // Regex simple para sacar ID
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = ytUrl.match(regExp);
                if (match && match[2].length === 11) {
                    ytId = match[2];
                }
            }
            
            // Recolectar Fotos
            let fotos = [];
            document.querySelectorAll('.photo-input').forEach((input, index) => {
                if(input.value.trim() !== "") {
                    fotos.push(`foto${index}=${encodeURIComponent(input.value)}`);
                }
            });

            // Construir URL Base (detecta si estamos en localhost o web)
            const baseUrl = window.location.href.split('?')[0];
            let finalUrl = `${baseUrl}?para=${para}&de=${de}&titulo=${titulo}&mensaje=${mensaje}`;
            
            if (ytId) finalUrl += `&yt=${ytId}`;
            if (fotos.length > 0) finalUrl += `&${fotos.join('&')}`;

            // Mostrar resultado
            const resultArea = document.getElementById('resultArea');
            const shareInput = document.getElementById('shareLink');
            
            resultArea.classList.remove('hidden');
            shareInput.value = finalUrl;
            
            // Scroll al resultado
            resultArea.scrollIntoView({ behavior: 'smooth' });
        });

        function copyLink() {
            const copyText = document.getElementById("shareLink");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("¬°Enlace copiado al portapapeles!");
        }

        function openLink() {
            window.location.href = document.getElementById("shareLink").value;
        }

        // --- 3. FUNCIONES DEL MODO CARTA ---

        function prepareCardData() {
            // Extraer y decodificar datos
            const de = params.get('de');
            const para = params.get('para');
            const titulo = params.get('titulo');
            const mensaje = params.get('mensaje');
            const yt = params.get('yt');

            // Setear textos est√°ticos
            document.getElementById('displayPara').textContent = para;
            document.getElementById('displayDe').textContent = de;
            document.getElementById('displayTitulo').textContent = titulo;
            messageText = mensaje; // Guardar para efecto m√°quina de escribir

            // L√≥gica M√∫sica
            if (yt) musicId = yt;

            // L√≥gica Fotos (Tu regla de las 5 fotos)
            let rawPhotos = [];
            for(let i=0; i<5; i++) {
                if(params.has(`foto${i}`)) {
                    rawPhotos.push(params.get(`foto${i}`));
                }
            }

            // Regla: Si hay fotos, completar 5. Si no hay, usar corazones.
            if (rawPhotos.length === 0) {
                // Caso: 0 fotos -> 5 corazones default
                for(let i=0; i<5; i++) {
                    photoUrls.push('https://images.unsplash.com/photo-1518199266791-5375a83190b7?q=80&w=400&auto=format&fit=crop'); // Corazones gen√©ricos
                }
            } else {
                // Caso: 1-4 fotos -> Repetir l√≥gica
                photoUrls = [...rawPhotos];
                while(photoUrls.length < 5) {
                    // A√±adir la primera foto al final hasta llegar a 5
                    photoUrls.push(rawPhotos[0]);
                }
            }

            // Renderizar Galer√≠a (Oculta hasta abrir sobre)
            const gallery = document.getElementById('photoGallery');
            photoUrls.forEach((url, index) => {
                // Rotaci√≥n aleatoria entre -5 y 5 grados
                const rotation = (Math.random() * 10) - 5;
                
                const div = document.createElement('div');
                div.className = 'polaroid';
                div.style.setProperty('--rotation', `${rotation}deg`);
                div.innerHTML = `
                    <div class="w-48 h-48 md:w-56 md:h-56 overflow-hidden bg-gray-100 mb-2">
                        <img src="${url}" class="w-full h-full object-cover" alt="Foto amor" onerror="this.src='https://placehold.co/400x400?text=Love'">
                    </div>
                `;
                gallery.appendChild(div);
            });
        }

        function openLetter() {
            const envelope = document.getElementById('mainEnvelope');
            envelope.classList.add('open');
            
            // 1. Iniciar M√∫sica (Usuario interactu√≥, autoplay permitido)
            if (musicId) {
                const player = document.createElement('iframe');
                player.width = "0";
                player.height = "0";
                // playlist=${musicId}&loop=1 asegura loop. autoplay=1 inicia.
                player.src = `https://www.youtube.com/embed/${musicId}?autoplay=1&loop=1&playlist=${musicId}&controls=0`;
                player.allow = "autoplay";
                player.style.display = "none";
                document.getElementById('music-container').appendChild(player);
            }

            // 2. Transici√≥n visual
            setTimeout(() => {
                envelopeView.style.opacity = '0';
                envelopeView.style.transition = 'opacity 1s';
                
                setTimeout(() => {
                    envelopeView.classList.add('hidden-section');
                    cardView.classList.remove('hidden-section');
                    
                    // 3. Iniciar Efectos
                    startPetals();
                    startTypewriter();
                }, 1000);
            }, 800);
        }

        // --- 4. EFECTOS VISUALES ---

        // M√°quina de Escribir
        function startTypewriter() {
            const element = document.getElementById('typewriterText');
            let i = 0;
            const speed = 50; // ms por letra

            function type() {
                if (i < messageText.length) {
                    // Manejo b√°sico de saltos de l√≠nea
                    if(messageText.charAt(i) === '\n') {
                         element.innerHTML += '<br>';
                    } else {
                         element.innerHTML += messageText.charAt(i);
                    }
                    i++;
                    setTimeout(type, speed);
                } else {
                    // Fin escritura
                    document.querySelector('.cursor').style.display = 'none';
                }
            }
            type();
        }

        // Lluvia de P√©talos
        function startPetals() {
            setInterval(() => {
                const petal = document.createElement('div');
                petal.classList.add('petal');
                petal.innerHTML = 'üå∏'; // O usar imagen SVG
                petal.style.left = Math.random() * 100 + 'vw';
                petal.style.fontSize = (Math.random() * 20 + 10) + 'px';
                petal.style.animationDuration = (Math.random() * 3 + 2) + 's';
                
                document.body.appendChild(petal);

                // Limpieza de memoria
                setTimeout(() => {
                    petal.remove();
                }, 5000);
            }, 300);
        }

        // Fallback m√∫sica (por si acaso)
        function toggleMusicHints() {
            alert("La m√∫sica se est√° reproduciendo de fondo a trav√©s de YouTube.");
        }

    </script>
</body>
</html>
